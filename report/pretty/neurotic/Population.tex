% Remember to use the lgrind style

\Head{}
\File{code/neurotic/Population.java}{2001}{5}{15}{13:30}{4819}
\L{\LB{\K{package}_\V{neurotic};}}
\L{\LB{}}
\L{\LB{\K{import}_\V{java}.\V{util}.*;}}
\L{\LB{\K{import}_\V{java}.\V{io}.*;}}
\L{\LB{\K{import}_\V{java}.\V{text}.*;}}
\L{\LB{}}
\L{\LB{\K{public}_\K{class}_\V{Population}_\{}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\V{Net}_\V{net};}}
\L{\LB{}\Tab{2}{\V{Fitness}_\V{fitfunc};}\Tab{24}{\C{}//_the_fitness_function\CE{}}}
\L{\LB{}\Tab{2}{\K{public}_\K{float}[\,][\,]_\V{weights};}\Tab{32}{\C{}//_weights_of_networks\CE{}}}
\L{\LB{}\Tab{2}{\K{public}_\K{float}[\,]_\V{fitness};}\Tab{32}{\C{}//_fitnesses_of_individuals\CE{}}}
\L{\LB{}\Tab{2}{\V{Random}_\V{rnd};}}
\L{\LB{}\Tab{2}{\K{int}_\V{envs};}\Tab{24}{\C{}//_number_of_environments_for_determining_fitness\CE{}}}
\L{\LB{}\Tab{2}{\K{float}_\V{muteRate};}\Tab{24}{\C{}//_mutation_rate\CE{}}}
\L{\LB{}\Tab{2}{\K{int}_\V{currGen};}\Tab{24}{\C{}//_current_generation\CE{}}}
\L{\LB{}\Tab{2}{\K{public}_\K{int}_\V{fittest},_\V{leastFit};}\Tab{32}{\C{}//_most_and_least_fit_individuals\CE{}}}
\L{\LB{}}
\index{Population}\Proc{Population}\L{\LB{}\Tab{2}{\K{public}_\V{Population}(\V{Net}_\V{net},_\V{Fitness}_\V{fitfunc},_\K{int}_\V{size},}}
\L{\LB{}\Tab{20}{\K{float}_\V{mean},_\K{float}_\V{range},_\K{float}_\V{muteRate},}}
\L{\LB{}\Tab{20}{\K{int}_\V{envs})_\{}}
\L{\LB{}\Tab{4}{\K{this}.\V{net}_=_\V{net};}}
\L{\LB{}\Tab{4}{\K{this}.\V{fitfunc}_=_\V{fitfunc};}}
\L{\LB{}\Tab{4}{\K{this}.\V{muteRate}_=_\V{muteRate};}}
\L{\LB{}\Tab{4}{\V{rnd}_=_\K{new}_\V{Random}();}}
\L{\LB{}\Tab{4}{\K{this}.\V{envs}_=_\V{envs};}}
\L{\LB{}\Tab{4}{\V{weights}_=_\K{new}_\K{float}[\V{size}][\,];}}
\L{\LB{}\Tab{4}{\K{this}.\V{fitness}_=_\K{new}_\K{float}[\V{size}];}}
\L{\LB{}\Tab{4}{\V{randomizePopulation}(\V{size},_\V{mean},_\V{range});}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}//_load_weights_from_input_stream_instead_of_initialising_randomly\CE{}}}
\L{\LB{}\Tab{2}{\C{}//_file_format:_size_muteRate_currGen_net.numWeights_weights\CE{}}}
\index{Population}\Proc{Population}\L{\LB{}\Tab{2}{\K{public}_\V{Population}(\V{Net}_\V{net},_\V{Fitness}_\V{fitfunc},_\K{int}_\V{envs},}}
\L{\LB{}\Tab{20}{\V{Reader}_\V{r})_\{}}
\L{\LB{}\Tab{4}{\K{this}.\V{net}_=_\V{net};}}
\L{\LB{}\Tab{4}{\K{this}.\V{fitfunc}_=_\V{fitfunc};}}
\L{\LB{}\Tab{4}{\V{rnd}_=_\K{new}_\V{Random}();}}
\L{\LB{}\Tab{4}{\K{this}.\V{envs}_=_\V{envs};}}
\L{\LB{}\Tab{4}{\K{try}_\{}}
\L{\LB{}\Tab{6}{\V{StreamTokenizer}_\V{in}_=_\K{new}_\V{StreamTokenizer}(\V{r});}}
\L{\LB{}\Tab{6}{\V{in}.\V{nextToken}();_\K{int}_\V{size}_=_(\K{int})_\V{in}.\V{nval};}}
\L{\LB{}\Tab{6}{\K{this}.\V{fitness}_=_\K{new}_\K{float}[\V{size}];}}
\L{\LB{}\Tab{6}{\V{in}.\V{nextToken}();_\V{muteRate}_=_(\K{float})_\V{in}.\V{nval};}}
\L{\LB{}\Tab{6}{\V{in}.\V{nextToken}();_\V{currGen}_=_(\K{int})_\V{in}.\V{nval};}}
\L{\LB{}\Tab{6}{\V{in}.\V{nextToken}();_\K{int}_\V{numWts}_=_(\K{int})_\V{in}.\V{nval};}}
\L{\LB{}\Tab{6}{\K{if}_(\V{numWts}_!=_\V{net}.\V{numWeights}())_}}
\L{\LB{}\Tab{8}{\K{throw}_\K{new}_\V{Error}(\S{}\3Population:_error_reading_input_file:_\3\SE{}+}}
\L{\LB{}\Tab{24}{\S{}\3wrong_number_of_weights_for_this_network.\3\SE{});}}
\L{\LB{}\Tab{6}{\V{weights}_=_\K{new}_\K{float}[\V{size}][\,];}}
\L{\LB{}\Tab{6}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{size};_\V{i}++)_\{}}
\L{\LB{}\Tab{8}{\V{weights}[\V{i}]_=_\K{new}_\K{float}[\V{numWts}];}}
\L{\LB{}\Tab{8}{\K{for}_(\K{int}_\V{j}=\N{0};_\V{j}\<\V{numWts};_\V{j}++)_\{}}
\L{\LB{}\Tab{10}{\V{in}.\V{nextToken}();}}
\L{\LB{}\Tab{10}{\V{weights}[\V{i}][\V{j}]_=_(\K{float})_\V{in}.\V{nval};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{6}{\}}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{4}{\K{catch}_(\V{IOException}_\V{e})_\{_\K{throw}_\K{new}_\V{Error}(\V{e}.\V{getMessage}());_\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}//_save_weights_to_output_stream\CE{}}}
\index{save}\Proc{save}\L{\LB{}\Tab{2}{\K{public}_\K{void}_\V{save}(\V{Writer}_\V{w})_\{}}
\L{\LB{}\Tab{4}{\V{DecimalFormat}_\V{d}_=_\K{new}_\V{DecimalFormat}(\S{}\30.\#\#\#\#\#\#\#\#\#\#\3\SE{});}}
\L{\LB{}\Tab{4}{\K{try}_\{}}
\L{\LB{}\Tab{6}{\V{w}.\V{write}(\V{weights}.\V{length}_+_\S{}\3_\3\SE{}_+_\V{muteRate}_+_\S{}\3_\3\SE{}_+}}
\L{\LB{}\Tab{14}{\V{currGen}_+_\S{}\3_\3\SE{}_+_\V{net}.\V{numWeights}()_+_\S{}\3\2n\3\SE{});}}
\L{\LB{}\Tab{6}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{weights}.\V{length};_\V{i}++)_\{}}
\L{\LB{}\Tab{8}{\K{for}_(\K{int}_\V{j}=\N{0};_\V{j}\<\V{net}.\V{numWeights}();_\V{j}++)_\{}}
\L{\LB{}\Tab{10}{\V{w}.\V{write}(\V{d}.\V{format}(\V{weights}[\V{i}][\V{j}])_+_\S{}\3_\3\SE{});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\V{w}.\V{write}(\S{}\3\2n\3\SE{});}}
\L{\LB{}\Tab{6}{\}}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{4}{\K{catch}_(\V{IOException}_\V{e})_\{_\K{throw}_\K{new}_\V{Error}(\V{e}.\V{getMessage}());_\}}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\index{popSize}\Proc{popSize}\L{\LB{}\Tab{2}{\K{public}_\K{int}_\V{popSize}()_\{_\K{return}_\V{weights}.\V{length};_\}}}
\index{getCurrGen}\Proc{getCurrGen}\L{\LB{}\Tab{2}{\K{public}_\K{int}_\V{getCurrGen}()_\{_\K{return}_\V{currGen};_\}}}
\L{\LB{}}
\index{randomizePopulation}\Proc{randomizePopulation}\L{\LB{}\Tab{2}{\K{public}_\K{void}_\V{randomizePopulation}(\K{int}_\V{size},_\K{float}_\V{mean},_\K{float}_\V{range})_\{}}
\L{\LB{}\Tab{4}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{size};_\V{i}++)_\{}}
\L{\LB{}\Tab{6}{\V{net}.\V{randomizeWeights}(\V{mean},_\V{range});}}
\L{\LB{}\Tab{6}{\V{weights}[\V{i}]_=_\V{net}.\V{getAllWeights}();}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{4}{\V{currGen}_=_\N{0};}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\index{measureFitness}\Proc{measureFitness}\L{\LB{}\Tab{2}{\K{float}_\V{measureFitness}(\K{int}_\V{i})_\{}}
\L{\LB{}\Tab{4}{\K{float}_\V{total}_=_\N{0};}}
\L{\LB{}\Tab{4}{\C{}//_System.err.println(i);\CE{}}}
\L{\LB{}\Tab{4}{\V{net}.\V{setAllWeights}(\V{weights}[\V{i}]);}}
\L{\LB{}\Tab{4}{\V{net}.\V{flushContext}(\N{0.5f});}}
\L{\LB{}\Tab{4}{\K{for}_(\K{int}_\V{j}=\N{0};_\V{j}\<\V{envs};_\V{j}++)_\{}}
\L{\LB{}\Tab{6}{\V{total}_+=_\V{fitfunc}.\V{score}(\V{net},_\V{j});}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{4}{\K{return}_\V{total};}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}//_randomly_select_two_candidates,_let_them_compete\CE{}}}
\L{\LB{}\Tab{2}{\C{}//_in_the_prediefined_environments,_and_replace_the\CE{}}}
\L{\LB{}\Tab{2}{\C{}//_loser_by_a_mutation_of_the_winner\CE{}}}
\index{tournamentSelect}\Proc{tournamentSelect}\L{\LB{}\Tab{2}{\K{void}_\V{tournamentSelect}()_\{}}
\L{\LB{}\Tab{4}{\K{int}_\V{a}_=_\V{rnd}.\V{nextInt}(\V{popSize}());}}
\L{\LB{}\Tab{4}{\K{int}_\V{b}_=_\V{rnd}.\V{nextInt}(\V{popSize}()\-\N{1});_\K{if}_(\V{b}\>=\V{a})_\V{b}++;}}
\L{\LB{}\Tab{4}{\K{int}_\V{winner}_=_\V{fitness}[\V{a}]_\>_\V{fitness}[\V{b}]_?_\V{a}_\V{:}_\V{b};}}
\L{\LB{}\Tab{4}{\K{int}_\V{loser}_=_(\V{a}==\V{winner})_?_\V{b}_\V{:}_\V{a};}}
\L{\LB{}\Tab{4}{\V{mutate}(\V{weights}[\V{winner}],\V{weights}[\V{loser}]);}}
\L{\LB{}\Tab{4}{\V{fitness}[\V{loser}]_=_\V{measureFitness}(\V{loser});}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}//_find_individuals_with_least_and_greatest_fitness\CE{}}}
\index{recalcStats}\Proc{recalcStats}\L{\LB{}\Tab{2}{\K{public}_\K{void}_\V{recalcStats}()_\{}}
\L{\LB{}\Tab{4}{\V{fittest}_=_\V{leastFit}_=_\-\N{1};}}
\L{\LB{}\Tab{4}{\K{float}_\V{max}_=_\V{Float}.\V{NEGATIVE\_INFINITY};}}
\L{\LB{}\Tab{4}{\K{float}_\V{min}_=_\V{Float}.\V{POSITIVE\_INFINITY};}}
\L{\LB{}\Tab{4}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{popSize}();_\V{i}++)_\{}}
\L{\LB{}\Tab{6}{\V{System}.\V{err}.\V{println}(\S{}\3\>_\3\SE{}_+_\V{i}_+_\S{}\3_:_\3\SE{}_+_\V{fitness}[\V{i}]);}}
\L{\LB{}\Tab{6}{\K{if}_(\V{fitness}[\V{i}]\>\V{max})_\{\V{fittest}=\V{i};_\V{max}=\V{fitness}[\V{i}];\}}}
\L{\LB{}\Tab{6}{\K{if}_(\V{fitness}[\V{i}]\<\V{min})_\{\V{leastFit}=\V{i};_\V{min}=\V{fitness}[\V{i}];\}}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{4}{\K{if}_(\V{fittest}==\-\N{1})_\K{throw}_\K{new}_\V{Error}}}
\L{\LB{}\Tab{23}{(\S{}\3All_\3\SE{}+\V{popSize}()+\S{}\3_fitnesses_\3\SE{}+}}
\L{\LB{}\Tab{24}{\S{}\3are_Float.NEGATIVE\_INFINITY.\3\SE{});}}
\L{\LB{}\Tab{4}{\K{if}_(\V{leastFit}==\-\N{1})_\K{throw}_\K{new}_\V{Error}}}
\L{\LB{}\Tab{23}{(\S{}\3All_\3\SE{}+\V{popSize}()+\S{}\3_fitnesses_\3\SE{}+}}
\L{\LB{}\Tab{24}{\S{}\3are_Float.POSITIVE\_INFINITY.\3\SE{});}\Tab{60}{}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\index{fittest}\Proc{fittest}\L{\LB{}\Tab{2}{\K{public}_\K{float}[\,]_\V{fittest}()_\{}}
\L{\LB{}\Tab{4}{\K{return}_\V{weights}[\V{fittest}];}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}//_progress_evolution_by_n_generations\CE{}}}
\index{evolve}\Proc{evolve}\L{\LB{}\Tab{2}{\K{public}_\K{void}_\V{evolve}(\K{int}_\V{n})_\{}}
\L{\LB{}\Tab{4}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{n};_\V{i}++)_\{}}
\L{\LB{}\Tab{6}{\V{fitfunc}.\V{initEnviros}(\V{envs});}}
\L{\LB{}\Tab{6}{\K{for}_(\K{int}_\V{j}=\N{0};_\V{j}\<\V{popSize}();_\V{j}++)_\V{fitness}[\V{j}]_=_\V{measureFitness}(\V{j});}}
\L{\LB{}\Tab{6}{\K{for}_(\K{int}_\V{j}=\N{0};_\V{j}\<\V{popSize}();_\V{j}++)_\V{tournamentSelect}();}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{4}{\V{currGen}_+=_\V{n};}}
\L{\LB{}\Tab{4}{\V{recalcStats}();}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\index{evolve}\Proc{evolve}\L{\LB{}\Tab{2}{\K{public}_\K{void}_\V{evolve}()_\{_\V{evolve}(\N{1});_\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}//_returns_a_mutation_of_the_given_float_array\CE{}}}
\index{mutate}\Proc{mutate}\L{\LB{}\Tab{2}{\K{float}[\,]_\V{mutate}(\K{float}[\,]_\V{in},_\K{float}_\V{range})_\{}}
\L{\LB{}\Tab{4}{\K{float}[\,]_\V{out}_=_(\K{float}[\,])_\V{in}.\V{clone}();}}
\L{\LB{}\Tab{4}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{out}.\V{length};_\V{i}++)}}
\L{\LB{}\Tab{6}{\V{out}[\V{i}]_+=_(\V{rnd}.\V{nextFloat}()_\-_\N{0.5f})_*_\V{range};}}
\L{\LB{}\Tab{4}{\K{return}_\V{out};}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}//_overwrites_{`}out{'}_with_a_mutation_of_{`}in{'}\CE{}}}
\index{mutate}\Proc{mutate}\L{\LB{}\Tab{2}{\K{void}_\V{mutate}(\K{float}[\,]_\V{in},_\K{float}[\,]_\V{out})_\{}}
\L{\LB{}\Tab{4}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{out}.\V{length};_\V{i}++)}}
\L{\LB{}\Tab{6}{\V{out}[\V{i}]_=_\V{in}[\V{i}]_+_(\V{rnd}.\V{nextFloat}()_\-_\N{0.5f})_*_\V{muteRate};}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{\}}}
