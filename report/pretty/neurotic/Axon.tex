% Remember to use the lgrind style

\Head{}
\File{code/neurotic/Axon.java}{2001}{5}{14}{19:01}{4454}
\L{\LB{\K{package}_\V{neurotic};}}
\L{\LB{}}
\L{\LB{\C{}/*_An_Axon_is_either_a_neuron_or_an_input_node:_anything}}
\L{\LB{}\Tab{3}{that_can_provide_an_input_to_a_neuron._All_we_care_is}}
\L{\LB{}\Tab{3}{that_the_neuron_at_the_other_end_of_the_forward_connection}}
\L{\LB{}\Tab{3}{can_get_at_its_output._*/\CE{}}}
\L{\LB{\K{abstract}_\K{class}_\V{Axon}_\{}}
\L{\LB{}\Tab{2}{\K{float}_\V{act};}}
\L{\LB{}\Tab{2}{\V{String}_\V{label};}}
\L{\LB{}\Tab{2}{\V{Link}[\,]_\V{outputs};}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}//_activation_value_(just_returns_cached_value,_*doesn{'}t*_recalculate)\CE{}}}
\index{act}\Proc{act}\L{\LB{}\Tab{2}{\K{float}_\V{act}()_\{_\K{return}_\V{act};_\}}}
\L{\LB{}\Tab{2}{\C{}//_arbitrary_name,_mainly_for_debugging\CE{}}}
\index{label}\Proc{label}\L{\LB{}\Tab{2}{\V{String}_\V{label}()_\{_\K{return}_\V{label};_\}_}}
\L{\LB{}}
\index{delta}\Proc{delta}\L{\LB{}\Tab{2}{\K{float}_\V{delta}()_\{}}
\L{\LB{}\Tab{4}{\K{throw}_\K{new}_\V{Error}(\S{}\3Unimplemented_delta_function_called_on_Axon.\3\SE{});}}
\L{\LB{}\Tab{4}{\C{}//_Yes,_it_is_a_bit_of_a_fudge,_but_it_keeps_a_lot_of_other\CE{}}}
\L{\LB{}\Tab{4}{\C{}//_things_neat.\CE{}}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\K{abstract}_\K{int}_\V{layer}();}\Tab{32}{\C{}//_0=input,_1=context,_2=hidden,_3=output\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}/*_Creating_two_interlinked_Axons_simultaneously_is_tricky,}}
\L{\LB{}\Tab{5}{so_we_create_the_input_one_first,_and_use_this_method_to_tell}}
\L{\LB{}\Tab{5}{it_who_it{'}s_outputting_to._(This_is_the_responsibility_of_the}}
\L{\LB{}\Tab{5}{output_Neuron.)_*/\CE{}}}
\index{addOutput}\Proc{addOutput}\L{\LB{}\Tab{2}{\K{void}_\V{addOutput}(\V{Link}_\V{x})_\{}}
\L{\LB{}\Tab{4}{\V{Link}[\,]_\V{os}_=_\K{new}_\V{Link}[\V{outputs}.\V{length}+\N{1}];}}
\L{\LB{}\Tab{4}{\V{System}.\V{arraycopy}(\V{outputs},_\N{0},_\V{os},_\N{0},_\V{outputs}.\V{length});}}
\L{\LB{}\Tab{4}{\V{os}[\V{outputs}.\V{length}]_=_\V{x};}}
\L{\LB{}\Tab{4}{\V{outputs}_=_\V{os};}}
\L{\LB{}\Tab{4}{\C{}//_Vector_would_be_neater,_but_might_slow_propagation_bits_down\CE{}}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}/*_Input_node:_just_stores_one_value_and_always_returns_it_as_its}}
\L{\LB{}\Tab{3}{activation._The_activation_can_be_changed_by_the_set()_method._*/\CE{}}}
\L{\LB{\K{class}_\V{InputNode}_\K{extends}_\V{Axon}_\{}}
\index{InputNode}\Proc{InputNode}\L{\LB{}\Tab{2}{\V{InputNode}(\K{float}_\V{act},_\V{String}_\V{label})_\{}}
\L{\LB{}\Tab{4}{\K{this}.\V{act}_=_\V{act};}}
\L{\LB{}\Tab{4}{\K{this}.\V{label}_=_\V{label};}}
\L{\LB{}\Tab{4}{\V{outputs}_=_\K{new}_\V{Link}[\N{0}];}}
\L{\LB{}\Tab{2}{\}}}
\index{layer}\Proc{layer}\L{\LB{}\Tab{2}{\K{int}_\V{layer}()_\{_\K{return}_\N{0};_\}}}
\index{set}\Proc{set}\L{\LB{}\Tab{2}{\K{void}_\V{set}(\K{float}_\V{act})_\{_\K{this}.\V{act}_=_\V{act};_\}}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}//_Class_for_hidden_and_output_nodes.\CE{}}}
\L{\LB{\K{class}_\V{Neuron}_\K{extends}_\V{Axon}_\{}}
\L{\LB{}\Tab{2}{\V{Link}[\,]_\V{inputs};}}
\L{\LB{}\Tab{2}{\K{float}_\V{delta};}\Tab{16}{\C{}//_for_backprop_calculation\CE{}}}
\L{\LB{}\Tab{2}{\V{Net}_\V{net};}\Tab{16}{\C{}//_parent_network,_to_determine_activation_fn_\&_suchlike\CE{}}}
\L{\LB{}\Tab{2}{\K{int}_\V{layer};}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}//_Initial_activation_is_irrelevant_for_neuron,_so_I_should\CE{}}}
\L{\LB{}\Tab{2}{\C{}//_probably_take_it_out_of_the_constructor\CE{}}}
\index{Neuron}\Proc{Neuron}\L{\LB{}\Tab{2}{\K{public}_\V{Neuron}(\V{Link}[\,]_\V{inputs},_\V{Net}_\V{net},_\K{int}_\V{layer},_\K{float}_\V{act},}}
\L{\LB{}\Tab{16}{\V{String}_\V{label})_\{}}
\L{\LB{}\Tab{4}{\K{this}.\V{inputs}_=_\V{inputs};}}
\L{\LB{}\Tab{4}{\K{this}.\V{outputs}_=_\K{new}_\V{Link}[\N{0}];}}
\L{\LB{}\Tab{4}{\K{this}.\V{net}_=_\V{net};}}
\L{\LB{}\Tab{4}{\K{this}.\V{layer}_=_\V{layer};}}
\L{\LB{}\Tab{4}{\K{this}.\V{act}_=_\V{act};}}
\L{\LB{}\Tab{4}{\K{this}.\V{label}_=_\V{label};}}
\L{\LB{}\Tab{4}{\C{}//_It{'}s_our_responsibility_to_set_{`}output{'}_on_the_links\CE{}}}
\L{\LB{}\Tab{4}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{inputs}.\V{length};_\V{i}++)_\{}}
\L{\LB{}\Tab{6}{\V{inputs}[\V{i}].\V{output}_=_\K{this};}}
\L{\LB{}\Tab{6}{\V{inputs}[\V{i}].\V{input}.\V{addOutput}(\V{inputs}[\V{i}]);}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\index{delta}\Proc{delta}\L{\LB{}\Tab{2}{\K{public}_\K{float}_\V{delta}()}\Tab{24}{\{_\K{return}_\V{delta};_\}}}
\index{layer}\Proc{layer}\L{\LB{}\Tab{2}{\K{public}_\K{int}_\V{layer}()}\Tab{24}{\{_\K{return}_\V{layer};_\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}/*_Now_that_I{'}ve_moved_context_nodes_into_their_own_class,}}
\L{\LB{}\Tab{5}{this_is_redundant,_at_least_if_I{'}m_sticking_to_SRNs._*/\CE{}}}
\index{addInputs}\Proc{addInputs}\L{\LB{}\Tab{2}{\K{public}_\K{void}_\V{addInputs}(\V{Link}[\,]_\V{xs})_\{}}
\L{\LB{}\Tab{4}{\C{}//_first,_set_the_outputs_for_the_links\CE{}}}
\L{\LB{}\Tab{4}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{xs}.\V{length};_\V{i}++)_\{}}
\L{\LB{}\Tab{6}{\V{xs}[\V{i}].\V{output}_=_\K{this};}}
\L{\LB{}\Tab{6}{\V{xs}[\V{i}].\V{input}.\V{addOutput}(\V{xs}[\V{i}]);}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{4}{\V{Link}[\,]_\V{newI}_=_\K{new}_\V{Link}[\V{inputs}.\V{length}_+_\V{xs}.\V{length}];}}
\L{\LB{}\Tab{4}{\V{System}.\V{arraycopy}(\V{inputs},_\N{0},_\V{newI},_\N{0},_\V{inputs}.\V{length});}}
\L{\LB{}\Tab{4}{\V{System}.\V{arraycopy}(\V{xs},_\N{0},_\V{newI},_\V{inputs}.\V{length},_\V{xs}.\V{length});}}
\L{\LB{}\Tab{4}{\C{}//_weights_etc._already_initialized_by_Link_constructor\CE{}}}
\L{\LB{}\Tab{4}{\V{inputs}_=_\V{newI};}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}/*_Calculate_our_activation_and_cache_it_in_{`}act{'}.}}
\L{\LB{}\Tab{5}{Does_NOT_force_recalculation_of_any_other_activations.}}
\L{\LB{}\Tab{2}{*/\CE{}}}
\index{recalc}\Proc{recalc}\L{\LB{}\Tab{2}{\K{public}_\K{void}_\V{recalc}()_\{}}
\L{\LB{}\Tab{4}{\K{float}_\V{sum}_=_\N{0};}}
\L{\LB{}\Tab{4}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{inputs}.\V{length};_\V{i}++)}}
\L{\LB{}\Tab{6}{\V{sum}_+=_\V{inputs}[\V{i}].\V{weight}_*_\V{inputs}[\V{i}].\V{input}.\V{act}();}}
\L{\LB{}\Tab{4}{\C{}//_XXX_this_is_a_bit_of_a_mess\CE{}}}
\L{\LB{}\Tab{4}{\K{if}_(\K{false})_\{}}
\L{\LB{}\Tab{4}{\K{if}_(\V{Debug}.\V{lots})_\{}}
\L{\LB{}\Tab{6}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{inputs}.\V{length};_\V{i}++)}}
\L{\LB{}\Tab{8}{\V{System}.\V{err}.\V{println}(\V{inputs}[\V{i}].\V{weight}+\S{}\3_*_\3\SE{}+\V{inputs}[\V{i}].\V{input}.\V{act}());}}
\L{\LB{}\Tab{6}{\V{System}.\V{err}.\V{println}(\S{}\3\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\3\SE{});}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{4}{\K{if}_(\V{Float}.\V{isNaN}(\V{sum}))_\{}}
\L{\LB{}\Tab{6}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{inputs}.\V{length};_\V{i}++)}}
\L{\LB{}\Tab{8}{\V{System}.\V{err}.\V{println}(\V{inputs}[\V{i}].\V{weight}+\S{}\3_*_\3\SE{}+\V{inputs}[\V{i}].\V{input}.\V{act}());}}
\L{\LB{}\Tab{6}{\K{throw}_\K{new}_\V{Error}(\S{}\3Looks_like_we{'}ve_hit_NaN.\,.\,.\3\SE{});}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{4}{\V{act}_=_\V{net}.\V{act}.\V{f}(\V{sum});}\Tab{32}{\C{}//_activation_function\CE{}}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\K{class}_\V{ContextNode}_\K{extends}_\V{Axon}_\{}}
\L{\LB{}\Tab{2}{\V{Link}_\V{input};}\Tab{16}{\C{}//_We_shouldn{'}t_have_more_than_one_input\CE{}}}
\L{\LB{}\Tab{2}{\V{Net}_\V{net};}\Tab{16}{\C{}//_parent_network,_to_determine_activation_fn_\&_suchlike\CE{}}}
\L{\LB{}}
\index{ContextNode}\Proc{ContextNode}\L{\LB{}\Tab{2}{\K{public}_\V{ContextNode}(\V{Net}_\V{net},_\K{float}_\V{act},_\V{String}_\V{label})_\{}}
\L{\LB{}\Tab{4}{\V{outputs}_=_\K{new}_\V{Link}[\N{0}];}}
\L{\LB{}\Tab{4}{\K{this}.\V{net}_=_\V{net};}}
\L{\LB{}\Tab{4}{\V{act}_=_\V{act};}}
\L{\LB{}\Tab{4}{\K{this}.\V{label}_=_\V{label};}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\index{layer}\Proc{layer}\L{\LB{}\Tab{2}{\K{public}_\K{int}_\V{layer}()_\{_\K{return}_\N{1};_\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}/*_A_context_node_just_copies_the_output_of_the_neuron_it{'}s}}
\L{\LB{}\Tab{5}{connected_to._*/\CE{}}}
\index{recalc}\Proc{recalc}\L{\LB{}\Tab{2}{\K{void}_\V{recalc}()_\{_\V{act}_=_\V{input}.\V{input}.\V{act}();_\}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\C{}/*_WARNING:_If_this_is_called_more_than_once,_an_output_of}}
\L{\LB{}\Tab{5}{the_node_at_the_other_end_of_the_old_link_will_still_be}}
\L{\LB{}\Tab{5}{pointing_hither,_and_all_hell_may_well_break_loose._So}}
\L{\LB{}\Tab{5}{DON{'}T_DO_IT_KIDS._*/\CE{}}}
\index{setInput}\Proc{setInput}\L{\LB{}\Tab{2}{\K{void}_\V{setInput}(\V{Link}_\V{l})_\{}}
\L{\LB{}\Tab{4}{\V{l}.\V{output}_=}\Tab{16}{\K{this};}}
\L{\LB{}\Tab{4}{\V{l}.\V{input}.\V{addOutput}(\V{l});}}
\L{\LB{}\Tab{4}{\V{input}_=_\V{l};}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{\}}}
