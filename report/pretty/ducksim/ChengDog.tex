% Remember to use the lgrind style

\Head{}
\File{code/ducksim/ChengDog.java}{2001}{3}{28}{16:03}{9212}
\L{\LB{\K{package}_\V{ducksim};}}
\L{\LB{}}
\L{\LB{\K{public}_\K{class}_\V{ChengDog}_\K{extends}_\V{AnimalModel}_\{}}
\L{\LB{}\Tab{2}{\C{}//_Dog?_It{'}s_a_real_bitch_and_no_mistake.\,.\,.\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{2}{\K{float}_\V{ARENASIZE},_\V{ARENAAREA};}}
\L{\LB{}\Tab{2}{\K{int}_\V{nFlockRadius};}}
\L{\LB{}\Tab{2}{\V{DogControl}_\V{state};}}
\L{\LB{}\Tab{2}{\V{Vec}_\V{G};}}
\L{\LB{}\Tab{2}{\K{int}_\V{phase}_=_\N{0};_\C{}//_the_part_of_the_algorithm_the_herder_is_currently_running\CE{}}}
\L{\LB{}\Tab{2}{\C{}//_NOTE_if_you_change_fspeed_from_3,_spiral_may_also_need_to_be_altered\CE{}}}
\L{\LB{}\Tab{2}{\K{float}_\V{spiral}_=_\N{0};_\C{}//_how_far_the_dog_circles_from_the_wall\CE{}}}
\L{\LB{}\Tab{2}{\K{float}_\V{fspeed}_=_\N{3};_\C{}//_speed_multiplier_when_dog_moves_fast\CE{}}}
\L{\LB{}\Tab{2}{\K{float}_\V{sspeed}_=_\N{0.2f};_\C{}//_speed_multiplier_when_dog_moves_slow\CE{}}}
\L{\LB{}\Tab{2}{\K{boolean}_\V{justFinished}_=_\K{true};}}
\L{\LB{}\Tab{2}{\C{}//_has_the_function_just_finished?_should_the_dog_wait_for_a_bit_to_show_off?\CE{}}}
\L{\LB{}\Tab{2}{\K{int}_\V{t};}}
\L{\LB{}\Tab{2}{\K{float}_\V{MAXRADIUS};}\Tab{20}{\C{}//_for_herder_wall_avoidance\CE{}}}
\L{\LB{}\Tab{2}{\K{float}_\V{FLIGHTDIST};}\Tab{21}{\C{}//_for_duck-herder_repulsion\CE{}}}
\L{\LB{}}
\index{ChengDog}\Proc{ChengDog}\L{\LB{}\Tab{2}{\V{ChengDog}(\V{DogControl}_\V{state},_\V{Vec}_\V{goal})_\{}}
\L{\LB{}\Tab{4}{\K{this}.\V{state}_=_\V{state};}}
\L{\LB{}\Tab{4}{\K{this}.\V{ARENASIZE}_=_\V{state}.\V{arenaSize}();}}
\L{\LB{}\Tab{4}{\K{this}.\V{ARENAAREA}_=_\V{state}.\V{arenaArea}();}}
\L{\LB{}\Tab{4}{\K{this}.\V{MAXRADIUS}}\Tab{20}{=_(\V{ARENASIZE}/\N{2})_\-_(\V{state}.\V{dogRadius}()_+_\N{5});}}
\L{\LB{}\Tab{4}{\K{this}.\V{FLIGHTDIST}_=_\N{1000}/\N{4};}\Tab{31}{\C{}//ARENASIZE/4\CE{}}}
\L{\LB{}\Tab{4}{\V{G}_=_\V{goal};}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\index{update}\Proc{update}\L{\LB{}\Tab{2}{\K{void}_\V{update}()_\{}}
\L{\LB{}\Tab{4}{\K{float}_\V{xstep}_=_\N{0};}}
\L{\LB{}\Tab{4}{\K{float}_\V{ystep}_=_\N{0};}}
\L{\LB{}\Tab{4}{\V{Vec}_\V{dogpos},_\V{force},_\V{wallpt},_\V{endpt},_\V{duckpos};}}
\L{\LB{}\Tab{4}{\V{Vec}_\V{F}_=_\V{state}.\V{flockCentre}();}}
\L{\LB{}\Tab{4}{\V{Vec}_\V{vArenaCentre}_=_\K{new}_\V{Vec}(\N{0},\N{0});}}
\L{\LB{}}
\L{\LB{}\Tab{4}{\K{for}_(\K{int}_\V{i}_=_\N{0};_\V{i}\<\V{state}.\V{dogs}();_\V{i}++)_\{_\C{}//_for_ahem.\,.\,._every_herder\CE{}}}
\L{\LB{}\Tab{6}{\V{Pos}_\V{dogstate}_=_\V{state}.\V{dog}(\V{i});}}
\L{\LB{}\Tab{6}{\V{dogpos}_=_\V{dogstate}.\V{p};}}
\L{\LB{}}
\L{\LB{}\Tab{6}{\K{switch}_(\V{phase})_\{}}
\L{\LB{}}
\L{\LB{}\Tab{6}{\K{case}_\N{0}\V{:}_\C{}//_find_nearest_point_on_wall_and_go_to_it._================\CE{}}}
\L{\LB{}\Tab{8}{\V{wallpt}_=_\V{dogpos}.\V{mi}(\V{vArenaCentre}).\V{unit}().}}
\L{\LB{}\Tab{10}{\V{ti}(\V{ARENASIZE}/\N{2}).\V{pl}(\V{vArenaCentre});}}
\L{\LB{}\Tab{8}{\V{force}_=_\V{wallpt}.\V{mi}(\V{dogpos}).\V{unit}().\V{ti}(\V{fspeed});}}
\L{\LB{}\Tab{8}{\V{state}.\V{setDongle}(\V{i},\V{state}.\V{calcAngle}(\V{force}));}}
\L{\LB{}\Tab{8}{\V{state}.\V{setDog}(\V{i},\V{force});}}
\L{\LB{}\Tab{8}{\V{dogstate}.\V{d}_=_\V{force};}}
\L{\LB{}\Tab{8}{\C{}//_we_can{'}t_apply_velocities_ourselves,_so_we_work_out\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_where_the_dog_*would*_be\CE{}}}
\L{\LB{}\Tab{8}{\V{dogstate}.\V{move}();}}
\L{\LB{}\Tab{8}{\C{}//_if_dog_is_at_wall,_turn_90_deg_and_enter_phase_1\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{wallpt}.\V{distTo}(\V{dogstate}.\V{p})_\<_\V{state}.\V{dogRadius}()+\N{10})_\{}}
\L{\LB{}\Tab{10}{\V{state}.\V{setDongle}(\V{i},_\V{state}.\V{dog}(\V{i}).\V{nAngle}_+_(\K{float})_\V{Math}.\V{PI}/\N{2}_);}}
\L{\LB{}\Tab{10}{\V{phase}_=_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{break};}}
\L{\LB{}}
\L{\LB{}\Tab{6}{\K{case}_\N{1}\V{:}_\C{}//_go_round_perimeter_========================================\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{float}_\V{theta}_=_\V{state}.\V{dog}(\V{i}).\V{nAngle};}}
\L{\LB{}\Tab{8}{\V{xstep}_=_(\K{float})_\V{Math}.\V{sin}(\V{theta});}}
\L{\LB{}\Tab{8}{\V{ystep}_=_(\K{float})_\V{Math}.\V{cos}(\V{theta});}}
\L{\LB{}\Tab{8}{\V{force}_=_\K{new}_\V{Vec}(\V{fspeed}*\V{xstep},_\V{fspeed}*\V{ystep});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//}\Tab{12}{richie{'}s_herder_circling_code\CE{}}}
\L{\LB{}\Tab{8}{\V{endpt}_=_\V{dogpos}.\V{pl}(\V{force});}}
\L{\LB{}\Tab{8}{\V{wallpt}_=_\V{endpt}.\V{mi}(\V{vArenaCentre}).\V{unit}().}}
\L{\LB{}\Tab{10}{\V{ti}(\V{MAXRADIUS}).\V{pl}(\V{vArenaCentre});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}_(\V{endpt}.\V{distTo}(\V{vArenaCentre})_\>_\V{MAXRADIUS})}}
\L{\LB{}\Tab{10}{\V{force}.\V{mieq}(\V{endpt}.\V{mi}(\V{wallpt}));}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{state}.\V{setDongle}(\V{i},_\V{state}.\V{calcAngle}(\V{force}));}}
\L{\LB{}\Tab{8}{\V{state}.\V{setDog}(\V{i},\V{force});}}
\L{\LB{}\Tab{8}{\V{dogstate}.\V{d}_=_\V{force};_\V{dogstate}.\V{move}();}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{int}_\V{closest}_=_\V{closestDuckToWall}();}}
\L{\LB{}\Tab{8}{\V{Vec}_\V{Fsub}_=_\V{F}.\V{ti}((\K{float})_\V{state}.\V{ducks}());_\C{}//_centre_of_subflock\CE{}}}
\L{\LB{}\Tab{8}{\V{Fsub}.\V{mieq}(\V{state}.\V{duckPos}(\V{closest}));}}
\L{\LB{}\Tab{8}{\V{Fsub}.\V{dieq}(_(\K{float})_(\V{state}.\V{ducks}()\-\N{1})_);}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{boolean}_\V{spiraltest}_=_\K{true};_\C{}//_start_spiralling_when_true\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{radiussub}_=_\N{0};}}
\L{\LB{}\Tab{8}{\C{}//_ie,_when_all_but_one_duck_(or_maybe_all)_are_far_from_wall\CE{}}}
\L{\LB{}\Tab{8}{\K{for}_(\K{int}_\V{k}=\N{0};_\V{k}_\<_\V{state}.\V{ducks}();_\V{k}++)_\{}}
\L{\LB{}\Tab{10}{\K{if}_(\V{k}_!=_\V{closest})_\{}}
\L{\LB{}\Tab{12}{\K{int}_\V{dist}_=_(\K{int})_\V{Fsub}.\V{distTo}(\V{state}.\V{duckPos}(\V{k}));}}
\L{\LB{}\Tab{12}{\V{radiussub}_=_\V{radiussub}\>\V{dist}_?_\V{radiussub}_\V{:}_\V{dist};}}
\L{\LB{}\Tab{12}{\K{if}_(\V{vArenaCentre}.\V{distTo}(\V{state}.\V{duckPos}(\V{k}))_}}
\L{\LB{}\Tab{16}{\>_(\V{ARENASIZE}/\N{2}_\-_\V{FLIGHTDIST}_\-_\N{20})_)}}
\L{\LB{}\Tab{14}{\V{spiraltest}_=_\K{false};}}
\L{\LB{}\Tab{10}{\}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{spiraltest})_\V{phase}_=_\N{11};}}
\L{\LB{}\Tab{8}{\K{break};}}
\L{\LB{}}
\L{\LB{}\Tab{6}{\K{case}_\N{11}\V{:}_\C{}//_spiral_inwards_=============================================\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{theta}_=_\V{state}.\V{dog}(\V{i}).\V{nAngle};}}
\L{\LB{}\Tab{8}{\V{xstep}_=_(\K{float})_\V{Math}.\V{sin}(\V{theta});}}
\L{\LB{}\Tab{8}{\V{ystep}_=_(\K{float})_\V{Math}.\V{cos}(\V{theta});}}
\L{\LB{}\Tab{8}{\V{force}_=_\K{new}_\V{Vec}(\V{fspeed}*\V{xstep},_\V{fspeed}*\V{ystep});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//}\Tab{12}{richie{'}s_herder_circling_code\CE{}}}
\L{\LB{}\Tab{8}{\V{endpt}_=_\V{dogpos}.\V{pl}(\V{force});}}
\L{\LB{}\Tab{8}{\V{wallpt}_=_\V{endpt}.\V{mi}(\V{vArenaCentre}).\V{unit}().}}
\L{\LB{}\Tab{10}{\V{ti}(\V{MAXRADIUS}\-\V{spiral}).\V{pl}(\V{vArenaCentre});_\C{}//_***\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}_(\V{endpt}.\V{distTo}(\V{vArenaCentre})_\>_\V{MAXRADIUS}\-\V{spiral})_\C{}//_***\CE{}}}
\L{\LB{}\Tab{10}{\V{force}.\V{mieq}(\V{endpt}.\V{mi}(\V{wallpt}));}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{state}.\V{setDongle}(\V{i},\V{state}.\V{calcAngle}(\V{force}));}}
\L{\LB{}\Tab{8}{\V{state}.\V{setDog}(\V{i},\V{force});}}
\L{\LB{}\Tab{8}{\V{dogstate}.\V{d}_=_\V{force};_\V{dogstate}.\V{move}();}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{closest}_=_\V{closestDuckToWall}();}}
\L{\LB{}\Tab{8}{\V{Fsub}_=_\V{F}.\V{ti}((\K{float})_\V{state}.\V{ducks}());_\C{}//_centre_of_subflock\CE{}}}
\L{\LB{}\Tab{8}{\V{Fsub}.\V{mieq}(\V{state}.\V{duckPos}(\V{closest}));}}
\L{\LB{}\Tab{8}{\V{Fsub}.\V{dieq}(_(\K{float})_(\V{state}.\V{ducks}()\-\N{1})_);}}
\L{\LB{}\Tab{8}{\V{radiussub}_=_\N{0};}}
\L{\LB{}\Tab{8}{\K{for}_(\K{int}_\V{k}=\N{0};_\V{k}_\<_\V{state}.\V{ducks}();_\V{k}++)_\{}}
\L{\LB{}\Tab{10}{\K{if}_(\V{k}_!=_\V{closest})_\{}}
\L{\LB{}\Tab{12}{\K{int}_\V{dist}_=_(\K{int})_\V{Fsub}.\V{distTo}(\V{state}.\V{duckPos}(\V{k}));}}
\L{\LB{}\Tab{12}{\V{radiussub}_=_\V{radiussub}\>\V{dist}_?_\V{radiussub}_\V{:}_\V{dist};}}
\L{\LB{}\Tab{10}{\}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}_(\K{true})_\C{}//_always_spiral\CE{}}}
\L{\LB{}\Tab{10}{\V{spiral}_=_\V{spiral}+\N{0.05f};_\C{}//_maybe_even_smaller_than_0.05?\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_if_dog_is_too_close_to_centre\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{dogpos}.\V{distTo}(\V{vArenaCentre})_\<_\V{FLIGHTDIST})_\{}}
\L{\LB{}\Tab{10}{\V{spiral}_=_\N{0};_\V{phase}_=_\N{0};}}
\L{\LB{}\Tab{10}{\C{}//_there{'}s_been_a_problem._go_back_to_start_of_algorithm\CE{}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_if_whole_flock_herded_and_lone_duck_is_\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_away_from_wall_enter_phase_5\CE{}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}_(\V{vArenaCentre}.\V{distTo}(\V{state}.\V{duckPos}(\V{closest}))_\<}}
\L{\LB{}\Tab{17}{(\V{ARENASIZE}/\N{2}_\-_\V{FLIGHTDIST})}}
\L{\LB{}\Tab{17}{\&\&_(\V{state}.\V{flockRadius}()_\<_(\N{90}+\N{7}*\V{state}.\V{ducks}())))}}
\L{\LB{}\Tab{10}{\V{phase}_=_\N{5};_\C{}//_move_flock_to_goal\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_if_sub-flock_*is*_a_flock,_ie._if_it_is_herded.\,.\,.\CE{}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}_((\V{radiussub}_\<_(\N{60}_+_\N{7}*\V{state}.\V{ducks}()))}}
\L{\LB{}\Tab{17}{\&\&_\C{}//_and_if_it{'}s_away_from_the_wall.\,.\,.\CE{}}}
\L{\LB{}\Tab{17}{((\V{Fsub}.\V{distTo}(\V{vArenaCentre})_+_\V{radiussub})_\<}}
\L{\LB{}\Tab{18}{(\V{ARENASIZE}/\N{2}_\-_\V{FLIGHTDIST}))}}
\L{\LB{}\Tab{17}{\&\&_\C{}//_double_check_that_lone_duck_isn{'}t_away_from_wall_too.\CE{}}}
\L{\LB{}\Tab{17}{(\V{vArenaCentre}.\V{distTo}(\V{state}.\V{duckPos}(\V{closest}))_\>_}}
\L{\LB{}\Tab{18}{(\V{ARENASIZE}/\N{2}_\-_\V{FLIGHTDIST})))}}
\L{\LB{}\Tab{10}{\V{phase}_=_\N{2};_\C{}//_then_enter_phase_2\CE{}}}
\L{\LB{}\Tab{8}{\K{break};}}
\L{\LB{}}
\L{\LB{}\Tab{6}{\K{case}_\N{2}\V{:}_\C{}//_go_back_to_wall_=============================================\CE{}}}
\L{\LB{}\Tab{8}{\V{wallpt}_=_\V{dogpos}.\V{mi}(\V{vArenaCentre}).\V{unit}().\V{ti}(\V{ARENASIZE}/\N{2}).}}
\L{\LB{}\Tab{10}{\V{pl}(\V{vArenaCentre});}}
\L{\LB{}\Tab{8}{\V{force}_=_\V{wallpt}.\V{mi}(\V{dogpos}).\V{unit}().\V{ti}(\V{fspeed});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{theta}_=_\V{state}.\V{calcAngle}(\V{force});}}
\L{\LB{}\Tab{8}{\V{state}.\V{setDongle}(\V{i},\V{theta});}}
\L{\LB{}\Tab{8}{\V{state}.\V{setDog}(\V{i},\V{force});}}
\L{\LB{}\Tab{8}{\V{dogstate}.\V{nAngle}_=_\V{theta};}}
\L{\LB{}\Tab{8}{\V{dogstate}.\V{d}_=_\V{force};_\V{dogstate}.\V{move}();}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{float}_\V{dist}_=_\V{wallpt}.\V{distTo}(\V{dogpos});_\C{}//_if_herder_is_at_wall,\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{dist}_\<_\V{state}.\V{dogRadius}()_+_\N{10})_\{_\C{}//_turn_90_deg_and_enter_phase_3\CE{}}}
\L{\LB{}\Tab{10}{\V{theta}_\-=_(\K{float})_\V{Math}.\V{PI}/\N{2};}}
\L{\LB{}\Tab{10}{\V{state}.\V{setDongle}(\V{i},\V{theta});}}
\L{\LB{}\Tab{10}{\V{phase}_=_\N{3};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{break};}}
\L{\LB{}}
\L{\LB{}\Tab{6}{\K{case}_\N{3}\V{:}_\C{}//_go_back_around_perimeter_====================================\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{theta}_=_\V{state}.\V{dog}(\V{i}).\V{nAngle};}}
\L{\LB{}\Tab{8}{\V{xstep}_=_(\K{float})_\V{Math}.\V{sin}(\V{theta});}}
\L{\LB{}\Tab{8}{\V{ystep}_=_(\K{float})_\V{Math}.\V{cos}(\V{theta});}}
\L{\LB{}\Tab{8}{\V{force}_=_\K{new}_\V{Vec}(\V{fspeed}*\V{xstep},_\V{fspeed}*\V{ystep});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//}\Tab{12}{richie{'}s_herder_circling_code\CE{}}}
\L{\LB{}\Tab{8}{\V{endpt}_=_\V{dogpos}.\V{pl}(\V{force});}}
\L{\LB{}\Tab{8}{\V{wallpt}_=_\V{vArenaCentre}.\V{dirTo}(\V{endpt}).\V{ti}(\V{MAXRADIUS}+\N{10}).\V{pl}(\V{vArenaCentre});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}_(\V{endpt}.\V{distTo}(\V{vArenaCentre})_\>_\V{MAXRADIUS}+\N{10})}}
\L{\LB{}\Tab{10}{\V{force}.\V{pleq}(\V{endpt}.\V{mi}(\V{wallpt}));}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{state}.\V{setDongle}(\V{i},\V{state}.\V{calcAngle}(\V{force}));}}
\L{\LB{}\Tab{8}{\C{}//_apply_force\CE{}}}
\L{\LB{}\Tab{8}{\V{state}.\V{setDog}(\V{i},\V{force});_\V{dogstate}.\V{d}_=_\V{force};}}
\L{\LB{}\Tab{8}{\V{dogstate}.\V{move}();}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{closest}_=_\V{closestDuckToWall}();}}
\L{\LB{}\Tab{8}{\V{Fsub}_=_\V{F}.\V{ti}((\K{float})\V{state}.\V{ducks}());}}
\L{\LB{}\Tab{8}{\V{Fsub}.\V{mieq}(\V{state}.\V{duck}(\V{closest}).\V{p});}}
\L{\LB{}\Tab{8}{\V{Fsub}.\V{dieq}((\K{float})(\V{state}.\V{ducks}()_\-_\N{1}));_\C{}//_Fsub_centre_of_sub-flock\CE{}}}
\L{\LB{}\Tab{8}{\V{duckpos}_=_\V{state}.\V{duck}(\V{closest}).\V{p};}}
\L{\LB{}\Tab{8}{\V{dogpos}_=_\V{dogstate}.\V{p};_\C{}//_dogpos_position_of_herder\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_if_you{'}re_close_to_duck_you{'}re_going_the_wrong_way\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{dogstate}.\V{p}.\V{distTo}(\V{duckpos})_\<_\V{FLIGHTDIST}_\-_\N{20})}}
\L{\LB{}\Tab{10}{\V{state}.\V{setDongle}(\V{i},\V{state}.\V{dog}(\V{i}).\V{nAngle}_+_(\K{float})_\V{Math}.\V{PI});}}
\L{\LB{}\Tab{8}{\K{else}_\{}}
\L{\LB{}\Tab{10}{\V{Vec}_\V{a}_=_\V{dogpos}.\V{dirTo}(\V{Fsub});}}
\L{\LB{}\Tab{10}{\V{Vec}_\V{b}_=_\V{Fsub}.\V{dirTo}(\V{duckpos});}}
\L{\LB{}\Tab{10}{\C{}//_by_seeing_if_they_are_equal:\CE{}}}
\L{\LB{}\Tab{10}{\K{if}_(\V{a}.\V{equals}(\N{0.01f},\V{b}))_\V{phase}_=_\N{4};}}
\L{\LB{}\Tab{10}{\C{}//_when_dog_is_behind_sub-flock_wrt._single_duck,_enter_phase_4\CE{}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{break};}}
\L{\LB{}}
\L{\LB{}\Tab{6}{\K{case}_\N{4}\V{:}_\C{}//_slowly_push_sub-flock_towards_single_duck\CE{}}}
\L{\LB{}\Tab{8}{\V{closdist}_=_\V{ARENASIZE};}}
\L{\LB{}\Tab{8}{\K{for}_(\V{k}=\N{0};_\V{k}_\<_\V{DuckList}.\V{GetSize}();_\V{k}++)_\C{}//_find_duck_closest_to_wall\CE{}}}
\L{\LB{}\Tab{10}{\{}}
\L{\LB{}\Tab{12}{\K{const}_\V{FVector}\&_\V{duckpos}_=_\V{DuckList}[\V{k}].\V{r};}}
\L{\LB{}\Tab{12}{\V{wallpt}_=_(\V{ARENASIZE}/\N{2})_*_\V{UnitVector}(\V{duckpos}_\-_\V{vArenaCentre})_+_\V{vArenaCentre};}}
\L{\LB{}\Tab{12}{\V{dist}_=_\V{abs}(\V{wallpt}_\-_\V{duckpos});}}
\L{\LB{}\Tab{12}{\K{if}_(\V{dist}_\<_\V{closdist})}}
\L{\LB{}\Tab{14}{\{}}
\L{\LB{}\Tab{16}{\V{closdist}_=_\V{dist};}}
\L{\LB{}\Tab{16}{\V{closest}_=_\V{k};}}
\L{\LB{}\Tab{14}{\}}}
\L{\LB{}\Tab{10}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{Fsub}_=_\V{F}_*_(\K{float})\V{DuckList}.\V{GetSize}();}\Tab{72}{}}
\L{\LB{}\Tab{8}{\V{Fsub}_\-=_\V{DuckList}[\V{closest}].\V{r};}}
\L{\LB{}\Tab{8}{\V{Fsub}_/=_(\K{float})(\V{DuckList}.\V{GetSize}()_\-_\N{1});_\C{}//_Fsub_centre_of_sub-flock\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{radiussub}_=_\N{0};}}
\L{\LB{}\Tab{8}{\K{for}_(\V{k}=\N{0};_\V{k}_\<_\V{DuckList}.\V{GetSize}();_\V{k}++)}}
\L{\LB{}\Tab{10}{\{}}
\L{\LB{}\Tab{12}{\K{if}_(\V{k}_!=_\V{closest})}}
\L{\LB{}\Tab{14}{\{}}
\L{\LB{}\Tab{16}{\K{int}_\V{dist}_=_(\K{int})_\V{abs}(\V{Fsub}_\-_\V{DuckList}[\V{k}].\V{r});}}
\L{\LB{}\Tab{16}{\V{radiussub}_=_\V{\_\_max}(\V{radiussub},_\V{dist});}}
\L{\LB{}\Tab{14}{\}}}
\L{\LB{}\Tab{10}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{herderpos}_=_\V{HerderList}[\V{i}].\V{r};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{force}_=_\V{UnitVector}(\V{DuckList}[\V{closest}].\V{r}_\-_\V{herderpos});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}_(\V{abs}(\V{Fsub}_\-_\V{herderpos})_\<_\V{radiussub}+\V{FLIGHTDIST}+\N{5})}}
\L{\LB{}\Tab{10}{\V{force}_*=_\V{sspeed};}}
\L{\LB{}\Tab{8}{\K{else}}}
\L{\LB{}\Tab{10}{\V{force}_*=_\V{fspeed};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Matt{'}s_updated_angle_code_in_floats_and_radians\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_scope_for_optimisation_here_but_not_going_into_it_yet\CE{}}}
\L{\LB{}\Tab{8}{\V{theta}_=_\V{atanf}(\V{force}.\V{x}_/\V{force}.\V{y});_\C{}//_note_sign_change!!\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{force}.\V{x}_\>_\N{0}_\&\&_\V{force}.\V{y}_\>\N{0})_}}
\L{\LB{}\Tab{10}{\{_\V{HerderList}[\V{i}].\V{nAngle}_=_\V{theta};\}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}_(\V{force}.\V{x}_\>_\N{0}_\&\&_\V{force}.\V{y}_\<_\N{0})_}}
\L{\LB{}\Tab{10}{\{_\V{HerderList}[\V{i}].\V{nAngle}_=_\V{M\_PI}_+_\V{theta};\}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}_(\V{force}.\V{x}_\<_\N{0}_\&\&_\V{force}.\V{y}_\<_\N{0})_}}
\L{\LB{}\Tab{10}{\{_\V{HerderList}[\V{i}].\V{nAngle}_=_\V{M\_PI}_+_\V{theta};\}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}_(\V{force}.\V{x}_\<_\N{0}_\&\&_\V{force}.\V{y}_\>_\N{0})}}
\L{\LB{}\Tab{10}{\{_\V{HerderList}[\V{i}].\V{nAngle}_=_\V{M\_2PI}_+_\V{theta};\}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}_(\V{force}.\V{x}_==_\N{0})}}
\L{\LB{}\Tab{10}{\K{if}_(\V{force}.\V{y}_\>=_\N{0})_\{_\V{HerderList}[\V{i}].\V{nAngle}_=_\N{0.0f};\}}}
\L{\LB{}\Tab{10}{\K{else}_\{_\V{HerderList}[\V{i}].\V{nAngle}_=_\V{M\_PI};\}}}
\L{\LB{}}
\L{\LB{}\Tab{32}{\C{}//_apply_force\CE{}}}
\L{\LB{}\Tab{8}{\V{HerderList}[\V{i}].\V{v}_=_\V{force};}}
\L{\LB{}}
\L{\LB{}\Tab{32}{\C{}//_apply_velocities\CE{}}}
\L{\LB{}\Tab{8}{\V{HerderList}[\V{i}].\V{r}_+=_\V{HerderList}[\V{i}].\V{v};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{dist}_=_\V{abs}(\V{DuckList}[\V{closest}].\V{r}_\-_\V{Fsub});}}
\L{\LB{}\Tab{8}{\C{}//if_(dist_-_radiussub_\<_ATTRACTDIST_-_80)_\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_when_ducks_close_enough_to_attract_each_other\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{abs}(\V{DuckList}[\V{closest}].\V{v})\>\N{0.2})}}
\L{\LB{}\Tab{10}{\{}\Tab{13}{\C{}//_turn_180_degrees_and_enter_phase_5\CE{}}}
\L{\LB{}\Tab{12}{\V{HerderList}[\V{i}].\V{nAngle}_+=_\V{M\_PI};}}
\L{\LB{}\Tab{12}{\V{phase}_=_\N{5};}}
\L{\LB{}\Tab{10}{\}}}
\L{\LB{}\Tab{8}{\K{break};}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}\Tab{6}{\}}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\index{postUpdate}\Proc{postUpdate}\L{\LB{}\Tab{2}{\K{void}_\V{postUpdate}()_\{\}}}
\L{\LB{}}
\index{closestDuckToWall}\Proc{closestDuckToWall}\L{\LB{}\Tab{2}{\K{private}_\K{int}_\V{closestDuckToWall}()_\{}}
\L{\LB{}\Tab{4}{\K{float}_\V{closdist}_=_\V{ARENASIZE};}}
\L{\LB{}\Tab{4}{\V{Vec}_\V{vArenaCentre}_=_\K{new}_\V{Vec}(\N{0},\N{0});}}
\L{\LB{}\Tab{4}{\K{int}_\V{closest}_=_\N{0};}}
\L{\LB{}\Tab{4}{\K{for}_(\K{int}_\V{k}=\N{0};_\V{k}_\<_\V{state}.\V{ducks}();_\V{k}++)_\{_\C{}//_find_duck_closest_to_wall\CE{}}}
\L{\LB{}\Tab{6}{\V{Vec}_\V{duckpos}_=_\V{state}.\V{duckPos}(\V{k});}}
\L{\LB{}\Tab{6}{\V{Vec}_\V{wallpt}_=_\V{duckpos}.\V{mi}(\V{vArenaCentre}).\V{unit}().}}
\L{\LB{}\Tab{8}{\V{ti}(\V{ARENASIZE}/\N{2}).\V{pl}(\V{vArenaCentre});}}
\L{\LB{}\Tab{6}{\K{float}_\V{dist}_=_\V{wallpt}.\V{distTo}(\V{duckpos});}}
\L{\LB{}\Tab{6}{\K{if}_(\V{dist}_\<_\V{closdist})}}
\L{\LB{}\Tab{8}{\{_\V{closdist}_=_\V{dist};_\V{closest}_=_\V{k};_\}}}
\L{\LB{}\Tab{4}{\}}}
\L{\LB{}\Tab{4}{\K{return}_\V{closest};}}
\L{\LB{}\Tab{2}{\}}}
\L{\LB{}}
\L{\LB{\}}}
